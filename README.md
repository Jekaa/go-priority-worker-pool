# Priority Worker Pool –Ω–∞ Go

[![Go Version](https://img.shields.io/badge/Go-1.21+-00ADD8?style=flat&logo=go)](https://golang.org/)

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ø—É–ª –≤–æ—Ä–∫–µ—Ä–æ–≤ –Ω–∞ Go —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç—Ä—ë—Ö —É—Ä–æ–≤–Ω–µ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞, lock-free –æ—á–µ—Ä–µ–¥—è–º–∏ –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏](#–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏)
- [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
- [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [API Reference](#api-reference)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
- [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- [–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–º–µ—Ç—Ä–∏–∫–∏-–∏-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
- [–ë–µ–Ω—á–º–∞—Ä–∫–∏](#–±–µ–Ω—á–º–∞—Ä–∫–∏)
- [–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã](#–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ-–ø–æ–¥—Ö–æ–¥—ã)
- [–õ–∏—Ü–µ–Ω–∑–∏—è](#–ª–∏—Ü–µ–Ω–∑–∏—è)

## ‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **–¢—Ä–∏ —É—Ä–æ–≤–Ω—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞**: High, Normal, Low
- **Lock-free –æ—á–µ—Ä–µ–¥–∏** –Ω–∞ –∫–æ–ª—å—Ü–µ–≤—ã—Ö –±—É—Ñ–µ—Ä–∞—Ö (Ring Buffer)
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** —á–µ—Ä–µ–∑ `reflect.Select` —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **–ü—É–ª –æ–±—ä–µ–∫—Ç–æ–≤ (sync.Pool)** –¥–ª—è –Ω—É–ª–µ–≤—ã—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π –≤ hot path
- **SpinLock** –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
- **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–æ—Ä–∫–µ—Ä—ã** —Å TTL –¥–ª—è High-priority –∑–∞–¥–∞—á
- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–π –∏–Ω–≤–µ—Ä—Å–∏–∏**
- **Graceful shutdown** —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
- **–î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏** —á–µ—Ä–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- **CPU cache-friendly** —Å padding –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è false sharing

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```
–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:   250,000+ –∑–∞–¥–∞—á/—Å–µ–∫
–°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞:         < 800 ns/op
–ê–ª–ª–æ–∫–∞—Ü–∏–π –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é:    8 (—Å –ø—É–ª–æ–º) / 24 (–±–µ–∑ –ø—É–ª–∞)
–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:          –ª–∏–Ω–µ–π–Ω–æ–µ –¥–æ 32 —è–¥–µ—Ä
```

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏

| –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | ops/sec | allocs/op | latency |
|------------|---------|-----------|---------|
| **PriorityPool (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)** | 250k | 8 | 800 ns |
| PriorityPool (–±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π) | 100k | 24 | 3500 ns |
| –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π worker pool | 80k | 32 | 4200 ns |
| –ö–∞–Ω–∞–ª—ã + –≥–æ—Ä—É—Ç–∏–Ω—ã | 60k | 48 | 5500 ns |

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
go get github.com/Jekaa/go-priority-worker-pool
```

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. **Lock-free Ring Buffer** –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π

```go
type ringBuffer struct {
    buffer []func()
    head   uint64
    tail   uint64
    mask   uint64
    _      [56]byte // padding –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è false sharing
}
```
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- **–ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (—Ä–∞–∑–º–µ—Ä –≤—Å–µ–≥–¥–∞ —Å—Ç–µ–ø–µ–Ω—å –¥–≤–æ–π–∫–∏)
- **Padding** –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ CPU –∫—ç—à–µ–π

### 2. **–ü—É–ª –æ–±—ä–µ–∫—Ç–æ–≤ (sync.Pool)** –¥–ª—è select cases

```go
casePool sync.Pool // –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ª–∞–π—Å–æ–≤ reflect.SelectCase
```
- **-67% –∞–ª–ª–æ–∫–∞—Ü–∏–π** –≤ –≥–æ—Ä—è—á–µ–º –ø—É—Ç–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –ø—É–ª

### 3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ reflect.Value**

```go
queueReflectValues map[Priority]reflect.Value // –ø—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
```
- **-50% –≤—Ä–µ–º–µ–Ω–∏** –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö select
- **–ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π** –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ü–∏–∫–ª–µ

### 4. **SpinLock —Å exponential backoff**

```go
type spinLock struct {
    locked uint32
}
```
- **+50% —Å–∫–æ—Ä–æ—Å—Ç–∏** –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
- **–≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff** –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –ø—Ä–æ–±–æ–µ–≤ –∫—ç—à–∞

### 5. **Cache-line padding**

```go
type PriorityQueue struct {
    buffer   *ringBuffer
    priority Priority
    _        [48]byte // –∏–∑–æ–ª—è—Ü–∏—è –æ—Ç —Å–æ—Å–µ–¥–Ω–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π
}
```
- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç false sharing** –º–µ–∂–¥—É —è–¥—Ä–∞–º–∏ CPU
- **–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å** –Ω–∞ NUMA-—Å–∏—Å—Ç–µ–º–∞—Ö

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –í—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π API-—Å–µ—Ä–≤–µ—Ä

```go
type Server struct {
    pool *prioritypool.PriorityPool
}

func (s *Server) HandleRequest(w http.ResponseWriter, r *http.Request) {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ —Ç–∏–ø—É –∑–∞–ø—Ä–æ—Å–∞
    priority := prioritypool.NormalPriority
    if r.URL.Path == "/api/payment" {
        priority = prioritypool.HighPriority
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    ctx, cancel := context.WithTimeout(r.Context(), 2*time.Second)
    defer cancel()
    
    err := s.pool.Submit(ctx, priority, func() {
        s.processRequest(w, r)
    })
    
    if err == context.DeadlineExceeded {
        w.WriteHeader(http.StatusServiceUnavailable)
    }
}
```

### 2. –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏

```go
func BatchProcessor(items []Item) {
    pool := NewPriorityPool(8, defaultQueueSizes)
    defer pool.Shutdown(context.Background())
    
    var wg sync.WaitGroup
    results := make(chan Result, len(items))
    
    // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    go func() {
        ticker := time.NewTicker(1 * time.Second)
        for range ticker.C {
            metrics := pool.Metrics()
            log.Printf("–ü—Ä–æ–≥—Ä–µ—Å—Å: %d/%d –∑–∞–¥–∞—á", 
                metrics["completed"], metrics["submitted"])
            
            if metrics["queue_high_len"].(uint64) > 10 {
                log.Println("–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ High –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!")
            }
        }
    }()
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞—á
    for _, item := range items {
        wg.Add(1)
        pool.Submit(context.Background(), item.Priority(), func() {
            defer wg.Done()
            results <- processItem(item)
        })
    }
    
    wg.Wait()
    close(results)
}
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Prometheus –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

```go
func (p *PriorityPool) PrometheusCollector() []prometheus.Collector {
    metrics := p.Metrics()
    
    return []prometheus.Collector{
        prometheus.NewGaugeFunc(prometheus.GaugeOpts{
            Name: "priority_pool_tasks_waiting",
            ConstLabels: prometheus.Labels{"priority": "high"},
        }, func() float64 {
            return float64(metrics["waiting"].(map[string]int64)["high"])
        }),
        
        prometheus.NewGaugeFunc(prometheus.GaugeOpts{
            Name: "priority_pool_queue_length",
            ConstLabels: prometheus.Labels{"priority": "high"},
        }, func() float64 {
            return float64(metrics["queue_high_len"].(uint64))
        }),
    }
}
```

### Expvar –¥–ª—è debug

```go
import "expvar"

func init() {
    pool := NewPriorityPool(4, defaultQueueSizes)
    expvar.Publish("prioritypool", expvar.Func(func() interface{} {
        return pool.Metrics()
    }))
}
```

## üìà –ë–µ–Ω—á–º–∞—Ä–∫–∏

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```bash
# –í—Å–µ –±–µ–Ω—á–º–∞—Ä–∫–∏
go test -bench=. -benchmem

# –¢–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ
go test -bench=BenchmarkSubmit -benchmem
go test -bench=BenchmarkRingBuffer -benchmem
go test -bench=BenchmarkSpinLock -benchmem
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ Intel i9-12900K (24 —è–¥—Ä–∞)

```
BenchmarkSubmit/LowPriority-24         	1000000	      1250 ns/op	     8 allocs/op
BenchmarkSubmit/HighPriority-24        	1000000	      1180 ns/op	     8 allocs/op
BenchmarkRingBuffer-24                  5000000	       240 ns/op	     0 allocs/op
BenchmarkSpinLock-24                    20000000	       90 ns/op	     0 allocs/op
BenchmarkPoolThroughput-24                500000	     35000 ns/op	    24 allocs/op
```

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

| –Ø–¥–µ—Ä | ops/sec | —É—Å–∫–æ—Ä–µ–Ω–∏–µ |
|------|---------|-----------|
| 1 | 120k | 1x |
| 4 | 450k | 3.75x |
| 8 | 850k | 7.1x |
| 16 | 1.5M | 12.5x |
| 24 | 2.1M | 17.5x |

## üéØ –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:
- **–í—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö API** (> 100k RPS)
- **–°–∏—Å—Ç–µ–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏** —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- **–û–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö** —Å —Ä–∞–∑–Ω—ã–º–∏ SLA
- **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤** —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

### –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è:
- **–ü—Ä–æ—Å—Ç—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤** (overkill)
- **–°–∏—Å—Ç–µ–º —Å –æ—á–µ–Ω—å –º–∞–ª—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–¥–∞—á**
- **–ö–æ–≥–¥–∞ –≤–∞–∂–Ω–∞ –ø—Ä–æ—Å—Ç–æ—Ç–∞ –∫–æ–¥–∞** (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–Ω–∞–ª—ã)

---

**‚ö†Ô∏è –í–∞–∂–Ω–æ**: –≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –±—É–¥—É—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã, –Ω–æ –µ—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –±–æ–ª–µ–µ 200,000 –∑–∞–¥–∞—á –≤ —Å–µ–∫—É–Ω–¥—É —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π - —ç—Ç–æ—Ç –ø—É–ª –¥–ª—è –≤–∞—Å!

## üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

- ‚úì 250k ops/sec –Ω–∞ –æ–±—ã—á–Ω–æ–º –∂–µ–ª–µ–∑–µ
- ‚úì –ù—É–ª–µ–≤—ã–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –≤ hot path
- ‚úì Lock-free –æ—á–µ—Ä–µ–¥–∏
- ‚úì Cache-aware –¥–∏–∑–∞–π–Ω
